// christopher pietsch
// cpietsch@gmail.com
// twitter @chrispiecom
// 2015-2016

// this is not meant for your eyes ;)
// not yet at least - will publish the code on github soon

function myListView(){function e(){}function t(e){if(!Ie){var t=d3.mouse(T.node()),n=a(t),i=v(n[0]-X,n[1]-X,{d:200,p:null},I)
if($=i.d,ae&&i.p&&i.p.ii<3&&$>7)he=null,G.center(null),b.style("cursor","default")
else{if(i.p&&!ge){var e=i.p,o=[(e.x+X)*w+W[0],(A+e.y+X)*w+W[1]]
G.center(o),he=e}b.style("cursor",function(){return i.d<5&&he.active?"pointer":"default"})}}}function n(e,t){pe=!pe
var n=d3.nest().key(function(e){return e.jahr}).entries(e)
n.forEach(function(e){var n=F(+e.key),a=e.values.length
e.values.sort(function(e,t){return t.keywords.length-e.keywords.length}),e.values.forEach(function(e,i){var o=Math.floor(i/Y)+2
e.ii=i,e.x=n+i%Y*(K/Y),e.y=(t?1:-1)*(o*(K/Y)),e.x1=e.x*L+V/2,e.y1=e.y*L+V/2,0==e.sprite.position.x&&(e.sprite.position.x=e.x1,e.sprite.position.y=e.y1),e.sprite2&&(e.sprite2.position.x=e.x*D+J/2,e.sprite2.position.y=e.y*D+J/2),e.order=1*(a-i)})})}function a(e){var t=[0,0]
return t[0]=e[0]/w-W[0]/w,t[1]=e[1]/w-A-W[1]/w,t}function i(){k.forEach(function(e,t){var n
n=e.x1-e.sprite.position.x,Math.abs(n)>.1&&(e.sprite.position.x+=.1*n),n=e.y1-e.sprite.position.y,Math.abs(n)>.1&&(e.sprite.position.y+=.1*n),n=e.alpha-e.sprite.alpha,Math.abs(n)>.01&&(e.sprite.alpha+=.2*n),e.sprite.visible=e.sprite.alpha>.1,e.sprite2&&(n=e.alpha2-e.sprite2.alpha,Math.abs(n)>.01&&(e.sprite2.alpha+=.2*n),e.sprite2.visible=e.sprite2.alpha>.1)})}function o(e){requestAnimationFrame(o),y(),i(),E.render(z),M.update()}function r(e,t){xe.zoomingToImage=!0,G.center(null),x(e),d3.select(".tagcloud").classed("hide",!0)
var n=F.rangeBand()/3/2,a=j/8,i=.6/(F.rangeBand()/3/j),o=[-i*(e.x-n)-a,-i*(A+e.y)]
ve=i,setTimeout(function(){d(e)},t/2),C.call(G.translate(W).event).transition().duration(t).call(G.scale(i).translate(o).event).each("end",function(){ge=!0,he=e,d(e),l(e),s(e,"click"),xe.zoomingToImage=!1})}function l(e){logger.log({action:"zoomToDetail",target:e.id}),re.select(".outer").node().scrollTop=0,re.classed("hide",!1).classed("sneak","en"==lang||utils.isMobile()).select(".inner").html(oe(e))
var t=re.select(".thementexte").text(e.thementexte.length?"":"Keine").selectAll("a").data(e.thementexte)
t.enter().append("a"),t.exit().remove(),t.attr("href",function(e){return("en"==lang?"../../vis/":"")+"thementexte/"+e.file}).attr("target","_blank").attr("title","zum PDF").text(function(e){return e.full_title})}function s(e,t){xe.lastZoomed=e.id
var n="https://s3.eu-central-1.amazonaws.com/fw4/large/"+e.id+".jpg"
LoaderBlob(n).finished(function(t){var n=new Image
n.addEventListener("load",function(){var t=new PIXI.BaseTexture(n),a=new PIXI.Texture(t),i=new PIXI.Sprite(a)
i.anchor.x=.5,i.anchor.y=.5,i.position.x=e.x*Z+Q/2,i.position.y=e.y*Z+Q/2,i._data=e,e.big=!0,ue.addChild(i)}),n.src=t})}function c(){for(;ue.children[0];)ue.children[0]._data.big=!1,ue.removeChild(ue.children[0])}function d(e){k.forEach(function(t){t.id!==e.id&&(t.alpha=0,t.alpha2=0)})}function u(){k.forEach(function(e){e.alpha=e.active?1:.2,e.alpha2=e.visible?1:0})}function p(e,t){H.forEach(function(t){t.pos=(t.x-e)*w,t.visible=t.pos>-K*w&&t.pos<j+100}),P.attr("class","timeline "+we(w)),P.style("font-size",function(){return 2*w+"px"})
var n=P.selectAll(".container").data(H),a=n.enter().append("div").classed("container",!0).on("mouseenter",function(e){Ie=!0,G.center(null),he=null,logger.log({action:"enter timeline",scale:w,translate:W,target:e.key})}).on("mouseleave",function(e){Ie=!1,logger.log({action:"exit timeline",scale:w,translate:W,target:e.key})})
a.append("div").classed("year",!0).text(function(e){return e.key})
var i=a.append("div").classed("entries",!0).selectAll(".entry").data(function(e){return e.values}).enter().append("div").classed("entry",!0)
i.append("div").classed("small",!0).append("div").classed("title",!0).text(function(e){return e.titel})
var o=i.append("div").classed("middle",!0)
o.append("div").classed("title",!0).text(function(e){return e.titel}),o.append("div").classed("text",!0).text(function(e){return e.text+"."})
var r=i.append("div").classed("large",!0)
r.append("div").classed("title",!0).text(function(e){return e.titel}),r.append("div").classed("text",!0).html(function(e){return e.text+".<br><br>"+e.extra}),n.style("transform",function(e){return"translate("+e.pos+"px,0px)"}).style("height",K*w+"px").style("width",K*w+"px").style("display",function(e){return e.visible?"block":"none"}),n.select(".year").style("font-size",ye(w)+"px")}function f(){W=d3.event.translate,w=d3.event.scale
var e=-1*W[0]/w,t=e+q/w,n=(W[1]+A*w,-ne[1]-te),a=(n-A)*w+A
ne[0]-te
null!=d3.event.sourceEvent&&(0>e?W[0]=0:t>q&&(W[0]=-1*(q*w-q)),W[1]<a&&(W[1]=a),G.translate([W[0],W[1]]),e=-1*W[0]/w,t=e+j/w),0!=ve&&w>ve&&!ge&&he&&"image"==he.type&&(ge=!0,G.center(null),ve=w,d(he),l(he)),ge&&ve-20>w&&(ge=!1,xe.lastZoomed=0,u(),c(),re.classed("hide",!0).classed("sneak","en"==lang)),p(e,t)
var i=A*w- -1*W[1]-U*w
P.style("transform","translate(0px,"+i+"px)"),w>me?d3.select(".tagcloud").classed("hide",!0):d3.select(".tagcloud").classed("hide",!1),se.scale.x=d3.event.scale,se.scale.y=d3.event.scale,se.x=d3.event.translate[0],se.y=d3.event.translate[1]}function h(e){Ee=!0,be=W,ke=w}function g(e){ee=W!==be,Ee=!1,m(),logger.log({action:"zoomend",translate:W,scale:w,target:he?he.id:""}),!ge||he.big||xe.lastZoomed==he.id||xe.zoomingToImage||s(he,"zoom")}function v(e,t,n,a){var i=a.x1,o=a.y1,r=a.x2,l=a.y2
if(a.visited=!0,e<i-n.d||e>r+n.d||t<o-n.d||t>l+n.d)return n
var s=a.point
if(s){s.scanned=!0
var c=s.x-e,d=s.y-t,u=Math.sqrt(c*c+d*d)
u<n.d&&(n.d=u,n.p=s)}var p=a.nodes,f=2*e>i+r,h=2*t>o+l
return p[2*h+f]&&(n=v(e,t,n,p[2*h+f])),p[2*h+(1-f)]&&(n=v(e,t,n,p[2*h+(1-f)])),p[2*(1-h)+f]&&(n=v(e,t,n,p[2*(1-h)+f])),p[2*(1-h)+(1-f)]&&(n=v(e,t,n,p[2*(1-h)+(1-f)])),n}function m(){var e=w
if(!ge){k.forEach(function(t,n){var a=t.sprite.position,i=a.x/L+W[0]/e,o=a.y/L+W[1]/e,r=5
i>-r&&j/e+r>i&&A/e+r>o+A&&o>-1*A-r?t.visible=!0:t.visible=!1})
var t=k.filter(function(e){return e.visible})
t.length<50?k.forEach(function(e){e.visible&&e.loaded&&e.active?e.alpha2=1:e.visible&&!e.loaded&&e.active?N.push(e):e.alpha2=0}):k.forEach(function(e){e.alpha2=0})}}function x(e){if(e.loaded)return void(e.alpha2=1)
if(imagesMap2.get(e.id)){var t=new Image
t.addEventListener("load",function(){var n=new PIXI.BaseTexture(t),a=new PIXI.Texture(n),i=new PIXI.Sprite(a)
i.anchor.x=.5,i.anchor.y=.5,i.position.x=e.x*D+J/2,i.position.y=e.y*D+J/2,i._data=e,de.addChild(i),e.sprite2=i,e.alpha2=e.highlight}),e.loaded=!0,t.src="data:image/jpg;base64,"+imagesMap2.get(e.id).image}}function y(){if(!Ee&&!ge&&N.length){var e=N.pop()
imagesMap2&&!e.loaded&&x(e)}}var w,I,b,k,E,z,M,C,P,X,T,S={top:20,right:50,bottom:30,left:50},B=400,j=window.innerWidth-S.left-S.right,q=window.innerWidth,A=window.innerHeight<B?B:window.innerHeight,L=1,D=1,Z=1,W=[0,0],w=1,H=[],N=[],F=d3.scale.ordinal().rangeBands([S.left,j+S.left],.2),O=d3.geom.quadtree().x(function(e){return e.x}).y(function(e){return e.y}),R=utils.isMobile()?600:450,G=d3.behavior.zoom().scaleExtent([1,R]).on("zoom",f).on("zoomend",g).on("zoomstart",h),K=0,U=0,V=100,J=1e3,Q=4e3,Y=3,$=0,ee=!1,te=50,ne=[0,0],ae=!0,ie=0,oe=_.template(d3.select("#detailTemplate").html()),re=d3.select(".sidebar").on("mouseenter",function(e){logger.log({action:"enter",scale:w,target:"detail"})}).on("mouseleave",function(e){logger.log({action:"exit",scale:w,target:"detail"})})
d3.select(".infobar").on("mouseenter",function(e){logger.log({action:"enter",scale:w,target:"infobar"})}).on("mouseleave",function(e){logger.log({action:"exit",scale:w,target:"infobar"})})
var le,z,se,ce,de,ue
e.resize=function(){j=window.innerWidth-S.left-S.right,A=window.innerHeight<B?B:window.innerHeight,q=window.innerWidth,E.resize(j+S.left+S.right,A),e.makeScales(),e.flip()},e.makeScales=function(){F.rangeBands([S.left,j+S.left],.2),K=F.rangeBand(),U=F.rangeBand()/3,X=K/Y/2,L=V/(F.rangeBand()/Y),D=J/(F.rangeBand()/Y),Z=Q/(F.rangeBand()/Y),ce.scale.x=1/L,ce.scale.y=1/L,ce.y=A,de.scale.x=1/D,de.scale.y=1/D,de.y=A,ue.scale.x=1/Z,ue.scale.y=1/Z,ue.y=A,H.forEach(function(e){e.x=F(e.key)})},e.init=function(n,a){k=n,b=d3.select(".page").append("div").classed("viz",!0),PIXI.SCALE_MODES.DEFAULT=PIXI.SCALE_MODES.NEAREST
var i={transparent:!1,resolution:1,antialiasing:!1}
E=new PIXI.WebGLRenderer(j+S.left+S.right,A,i),E.backgroundColor=1842719,window.renderer=E
var l=d3.select(b.node().appendChild(E.view))
M=new Stats,document.body.appendChild(M.domElement),z=new PIXI.Container,se=new PIXI.Container,ce=new PIXI.Container,de=new PIXI.Container,ue=new PIXI.Container,z.addChild(se),se.addChild(ce),se.addChild(de),se.addChild(ue),k.forEach(function(e,t){var n=PIXI.Texture.fromImage("data:image/jpg;base64,"+imagesMap.get(e.id).image),a=new PIXI.Sprite(n)
a.anchor.x=.5,a.anchor.y=.5,a._data=e,e.sprite=a,ce.addChild(a)}),a.forEach(function(e){e.jahr=e.jahr.split("-")[0],e.jahr=1*e.jahr,e.type="timeline","en"==lang&&(e.titel=e.titelEN,e.text=e.textEN,e.extra=e.extraEN)})
var s=d3.nest().key(function(e){return e.jahr}).entries(n.concat(a)).sort(function(e,t){return e.key-t.key}).map(function(e){return 1*e.key})
H=s.map(function(e){return{key:e,values:a.filter(function(t){return e==t.jahr})}}),F.domain(s),e.makeScales(),T=d3.select(".viz").call(G).on("mousemove",t).on("dblclick.zoom",null).on("touchstart",function(e){t(e),ie=1*new Date}).on("touchend",function(e){var t=1*new Date-ie
t>250||$>15||(!he||he.id)&&(!he||he.active)&&(ee||r(he,1400/Math.sqrt(Math.sqrt(w))))}).on("click",function(){(!he||he.id)&&(ee||$>15||(!he||he.active)&&(Ie||(Math.abs(ve-w)<.1?(logger.log({action:"zoomback",scale:w,target:he?he.id:""}),e.resetZoom()):(logger.log({action:"zoomto",scale:w,target:he?he.id:""}),r(he,1400/Math.sqrt(Math.sqrt(w)))))))}),C=l,P=d3.select(".viz").append("div").classed("timeline",!0).style("transform","translate(0px,"+(A-30)+"px)"),e.flip(),o()}
var pe=!1
e.distance=function(e,t){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))},e.click=function(e){},e.mousemove=function(t){if(!cloud.lock){var n=d3.mouse(this),a=[t.point.x,t.point.y]
e.distance(n,a)}},e.mouseout=function(e){cloud.lock||(me>w&&cloud.mouseleave(),le.hide())},e.mousedown=function(e){if(!ee){var e=e.point
ee||r(e,1e3/Math.sqrt(Math.sqrt(w)))}}
var fe=""
e.clearSearch=function(){fe=""}
var he=null,ge=!1,ve=117,me=2,xe={lastZoomed:0,zoomingToImage:!1},ye=d3.scale.linear().domain([1,9]).range([9,20]).clamp(!0),we=(d3.scale.linear().domain([2,8,20]).range([9,14,19]).clamp(!0),d3.scale.threshold().domain([3,10,20]).range(["none","small","middle","large"])),Ie=!1,be=[0,0],ke=0,Ee=!1
return e.highlight=function(){k.forEach(function(e,t){e.alpha=e.highlight?1:.2})},e.resetZoom=function(){var e=1400
ne=d3.extent(k,function(e){return e.y})
var t=-ne[1]-te
ae=-30>t&&t>-40,C.call(G.translate(W).event).transition().duration(e).call(G.scale(1).translate([0,t]).event)},e.flip=function(){e.split(),e.resetZoom()},e.split=function(){var e=k.filter(function(e){return e.active})
n(e,!1)
var t=k.filter(function(e){return!e.active})
n(t,!0),I=O(k)},e}